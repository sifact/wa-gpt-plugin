const r={activeChatGPTResolver:null,timeoutId:null};function l(){r.timeoutId&&(clearTimeout(r.timeoutId),r.timeoutId=null),r.activeChatGPTResolver=null,console.log("Background: Cleared resolver store")}async function g(e,a=1e4){console.log(`Background: Waiting for tab ${e} to load...`);const o=Date.now();for(;Date.now()-o<a;){try{const t=await chrome.tabs.get(e);if(t.status==="complete"){console.log(`Background: Tab ${e} finished loading at URL: ${t.url}`),await new Promise(s=>setTimeout(s,500));return}}catch(t){throw console.error(`Background: Error getting tab ${e} status during waitForTabLoad:`,t),new Error(`Tab ${e} might have been closed or an error occurred.`)}await new Promise(t=>setTimeout(t,250))}console.warn(`Background: Tab ${e} did not complete loading within ${a/1e3} seconds.`)}async function d(e){return console.log("Background: Attempting to fetch answer from ChatGPT web UI for:",e),console.log("Background: Current state of resolverStore:",r==null?void 0:r.activeChatGPTResolver),new Promise(async(a,o)=>{if(r.activeChatGPTResolver){o("Another ChatGPT request is already in progress.");return}r.activeChatGPTResolver={resolve:a,reject:o};let t=null;try{const s=await chrome.tabs.query({url:"https://chatgpt.com/*"});if(s.length>0?(t=s[0],await chrome.tabs.update(t.id,{active:!0}),console.log("Background: Found existing ChatGPT tab:",t.id,"(activating it for interaction)."),await g(t.id,5e3)):(t=await chrome.tabs.create({url:"https://chatgpt.com/*",active:!0}),await g(t.id,15e3)),!t||!t.id)throw new Error("ChatGPT tab could not be identified.");await chrome.scripting.executeScript({target:{tabId:t.id},files:["./chatgpt/chatgpt-interactor.js"]}),console.log("Background: Injected chatgpt-interactor.js into tab:",t.id),await new Promise(i=>setTimeout(i,500)),chrome.tabs.sendMessage(t.id,{action:"askQuestion",question:e},i=>{chrome.runtime.lastError?(console.error("Background: Error sending question to chatgpt-interactor:",chrome.runtime.lastError.message),r.activeChatGPTResolver&&r.activeChatGPTResolver.reject(chrome.runtime.lastError.message),l()):i&&i.status==="processing"?console.log("Background: Question sent to chatgpt-interactor, awaiting response."):(console.warn("Background: Unexpected response from chatgpt-interactor on askQuestion:",i),r.activeChatGPTResolver&&r.activeChatGPTResolver.reject("Unexpected response from interactor: "+JSON.stringify(i)),l())});const u=setTimeout(()=>{r.activeChatGPTResolver&&(console.warn("Background: ChatGPT interaction timed out."),r.activeChatGPTResolver.reject("ChatGPT interaction timed out."),l())},6e4);r.timeoutId=u}catch(s){console.error("Background: Error in fetchChatGPTAnswer process:",s),r.activeChatGPTResolver&&r.activeChatGPTResolver.reject(s.message||"Failed to interact with ChatGPT tab"),l()}})}function h(e,a){chrome.runtime.sendMessage({action:"injectResponse",conversationId:e,answer:a},o=>{chrome.runtime.lastError?console.warn("Background (via executeScript): Error sending injectResponse to content script:",chrome.runtime.lastError.message):console.log("Background (via executeScript): injectResponse message sent to content script, response:",o)})}function m(){chrome.tabs.query({url:["https://web.whatsapp.com/*"]},e=>{e.forEach(a=>{chrome.tabs.sendMessage(a.id,{action:"settingsUpdated"},o=>{chrome.runtime.lastError})})})}async function f(e,a){try{const o=await d(e.question);console.log("Background: Sending answer to WhatsApp Web content script:",o.length>50?o.substring(0,50)+"...":o),a({answer:o})}catch(o){console.error("Background: Error getting answer from ChatGPT UI:",o),a({error:"Failed to get answer from ChatGPT UI: "+o})}}async function p(e,a,o){const{conversationId:t,answer:s}=e;console.log(`Background: Attempting to open/focus WhatsApp conversation ${t} and respond.`);const u="https://web.whatsapp.com/*";let i=await chrome.tabs.query({url:u}),n=null;if(i.length>0)n=i[0],await chrome.tabs.update(n.id,{active:!0}),await chrome.windows.update(n.windowId,{focused:!0}),console.log(`Background: Found existing WhatsApp Web tab ${n.id}, focusing it.`);else try{n=await chrome.tabs.create({url:"https://web.whatsapp.com/",active:!0}),console.log(`Background: No WhatsApp Web tab found. Created new tab ${n.id}.`),await new Promise(c=>setTimeout(c,5e3))}catch(c){console.error("Background: Error creating new tab:",c),o({status:"Error creating tab",error:c.message});return}if(n&&n.id)try{await chrome.scripting.executeScript({target:{tabId:n.id},func:h,args:[e.conversationId,e.answer]}),console.log(`Background: Script execution initiated in tab ${n.id} for conversation ${t}.`),o({status:"Response injection initiated."})}catch(c){console.error(`Background: Error executing script in tab ${n.id}:`,c),o({status:"Error executing script",error:c.message})}else console.error("Background: No target tab could be identified or created."),o({status:"Failed to find or create WhatsApp Web tab."})}console.log("Background service worker started.");chrome.runtime.onMessage.addListener((e,a,o)=>{if(console.log("Background: Message received",e),e.action==="getAnswerFromChatGPT")return f(e,o),!0;if(e.action==="openConversationAndRespond")return p(e,a,o),!0;if(e.action==="getSettings")return chrome.storage.sync.get(["isEnabled","isPartialAutomation"],t=>{chrome.runtime.lastError?(console.error("Background: Error getting settings:",chrome.runtime.lastError.message),o({error:chrome.runtime.lastError.message})):(t.isEnabled===void 0&&(console.log("Background: isEnabled setting not found, using default value: false"),t.isEnabled=!1),t.isPartialAutomation===void 0&&(console.log("Background: isPartialAutomation setting not found, using default value: false"),t.isPartialAutomation=!1),t.customResponsePrefix="",console.log("Background: Returning settings:",t),o(t))}),!0;if(e.action==="saveSettings")return console.log("Background: Saving settings received from popup:",e.settings),chrome.storage.sync.set({isEnabled:e.settings.isEnabled===!0,isPartialAutomation:e.settings.isPartialAutomation===!0},()=>{chrome.runtime.lastError?(console.error("Background: Error saving settings:",chrome.runtime.lastError.message),o({error:chrome.runtime.lastError.message})):(console.log("Background: Settings successfully saved:",e.settings),chrome.storage.sync.get(["isEnabled","isPartialAutomation"],t=>{console.log("Background: Verification - settings after save:",t)}),o({status:"Settings saved"}),m())}),!0;if(e.action==="chatGPTResponse")return console.log("Background: Received response from ChatGPT Interactor:",e.answer||e.error),r.activeChatGPTResolver?(e.answer?r.activeChatGPTResolver.resolve(e.answer):r.activeChatGPTResolver.reject(e.error||"Unknown error from ChatGPT interactor"),l(),console.log("Background: Cleared resolver store after processing response")):(console.warn("Background: Received chatGPTResponse but no active resolver found. This may indicate a race condition."),l()),o({status:"Response noted by background"}),!0});chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"?(chrome.storage.sync.set({isEnabled:!1,isPartialAutomation:!1}),console.log("Background: Default settings saved on install - isEnabled: false"),console.log("Meta Suite ChatGPT Bridge installed. Default settings saved. Automation is OFF by default.")):e.reason==="update"&&console.log("Meta Suite ChatGPT Bridge updated to version "+chrome.runtime.getManifest().version)});
